package com.example.gonglee.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
* ============================================
* worldcup.html í†µí•© íŒŒì¼ìš© Controller
* ============================================
*
* êµ¬ì¡°: worldcup.html 1ê°œ íŒŒì¼ì— ëª¨ë“  í˜ì´ì§€ í¬í•¨
* - ì˜¨ë³´ë”© í˜ì´ì§€ (JavaScriptë¡œ showPage('onboarding'))
* - ê²Œì„ ì„ íƒ í˜ì´ì§€ (showPage('worldcup'))
* - ê²Œì„ ì§„í–‰ í˜ì´ì§€ (showPage('gameplay'))
* - ê²°ê³¼ í˜ì´ì§€ (showPage('result'))
*
* Controller ì—­í• :
* 1. "/" ê²½ë¡œ â†’ worldcup.html ë°˜í™˜
* 2. "/worldcup" ê²½ë¡œ â†’ worldcup.html ë°˜í™˜
* 3. API: ìºë¦­í„° ë°ì´í„° ì œê³µ
*/
@Controller
public class WorldcupController {

private static final String CHARACTERS_JSON_PATH = "characters.json";
private List<Map<String, Object>> charactersCache;

/**
* 1ï¸âƒ£ ì˜¨ë³´ë”© í˜ì´ì§€ ì§„ì…
*
* URL: http://localhost:8080/
*
* ì‘ë™:
* - worldcup.html ë°˜í™˜
* - JavaScriptì˜ showPage('onboarding') ì‹¤í–‰
* - í’€ìŠ¤í¬ë¦° ë¡œê³  + í´ë¦­ í…ìŠ¤íŠ¸ í‘œì‹œ
*/
@GetMapping("/")
public String index() {
System.out.println("âœ… ì˜¨ë³´ë”© í˜ì´ì§€ ì ‘ì†: GET /");
return "worldcup";  // src/main/resources/templates/worldcup.html
}

/**
* 2ï¸âƒ£ ê²Œì„ í˜ì´ì§€ (ê°™ì€ íŒŒì¼)
*
* URL: http://localhost:8080/worldcup
*
* ì‘ë™:
* - ê°™ì€ worldcup.html ë°˜í™˜
* - JavaScriptì˜ showPage('worldcup') ì‹¤í–‰
* - ì„±ë³„/ì¹´í…Œê³ ë¦¬ ì„ íƒ í™”ë©´ í‘œì‹œ
*/
@GetMapping("/worldcup")
public String worldcup() {
System.out.println("âœ… ì›”ë“œì»µ í˜ì´ì§€ ì ‘ì†: GET /worldcup");
return "worldcup";  // ê°™ì€ íŒŒì¼
}

/**
* 3ï¸âƒ£ API - ì›”ë“œì»µ ì‹œì‘ (í•„í„°ë§ëœ ìºë¦­í„°)
*
* URL: http://localhost:8080/api/worldcup/start?tour=male&cat=idol
*
* íŒŒë¼ë¯¸í„°:
* - tour: male ë˜ëŠ” female
* - cat: idol ë˜ëŠ” actor
*
* ì‘ë‹µ: JSON ë°°ì—´ (16ëª…)
*
* JavaScriptì—ì„œ í˜¸ì¶œ:
* ```javascript
* fetch('/api/worldcup/start?tour=male&cat=idol')
*   .then(res => res.json())
*   .then(data => {
*       // data = 16ëª… ë°°ì—´
*       // ê²Œì„ ì‹œì‘
*   })
* ```
*/
@GetMapping("/api/worldcup/start")
@ResponseBody
public ResponseEntity<?> startWorldcup(
@RequestParam(name = "tour") String tour,
@RequestParam(name = "cat") String cat) {
try {
// 1ë‹¨ê³„: ìºì‹œ í™•ì¸
if (charactersCache == null) {
System.out.println("ğŸ“ ìºë¦­í„° ë°ì´í„° ë¡œë“œ ì¤‘...");
charactersCache = loadCharactersFromJson();
System.out.println("âœ… ìºë¦­í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ: " + charactersCache.size() + "ëª…");
} else {
System.out.println("ğŸ’¾ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©");
}

// 2ë‹¨ê³„: íŒŒë¼ë¯¸í„° ë³€í™˜
String gender = tour.equals("male") ? "M" : "F";
String category = cat;

System.out.println("ğŸ” í•„í„°ë§: gender=" + gender + ", category=" + category);

// 3ë‹¨ê³„: í•„í„°ë§
List<Map<String, Object>> filtered = charactersCache.stream()
.filter(c -> c.get("gender").equals(gender) &&
c.get("category").equals(category))
.collect(Collectors.toList());

System.out.println("âœ… í•„í„°ë§ ê²°ê³¼: " + filtered.size() + "ëª…");

// 4ë‹¨ê³„: ì‘ë‹µ
return ResponseEntity.ok(filtered);

} catch (IOException e) {
System.err.println("âŒ ì—ëŸ¬: " + e.getMessage());
e.printStackTrace();
return ResponseEntity.status(500)
.body("{'error': 'Failed to load characters'}");
}
}

/**
* 4ï¸âƒ£ API - ëª¨ë“  ìºë¦­í„° ì¡°íšŒ
*
* URL: http://localhost:8080/api/characters
*
* ì‘ë‹µ: JSON ë°°ì—´ (64ëª…)
*
* ìš©ë„: ì§ˆë¬¸ ìƒì„± í˜ì´ì§€ì—ì„œ ìºë¦­í„° ì„ íƒ
*/
@GetMapping("/api/characters")
@ResponseBody
public ResponseEntity<?> getCharacters() {
try {
if (charactersCache == null) {
System.out.println("ğŸ“ ìºë¦­í„° ë°ì´í„° ë¡œë“œ ì¤‘...");
charactersCache = loadCharactersFromJson();
System.out.println("âœ… ìºë¦­í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ: " + charactersCache.size() + "ëª…");
} else {
System.out.println("ğŸ’¾ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©");
}
return ResponseEntity.ok(charactersCache);
} catch (IOException e) {
System.err.println("âŒ ì—ëŸ¬: " + e.getMessage());
return ResponseEntity.status(500)
.body("{'error': 'Failed to load characters'}");
}
}

/**
* JSON íŒŒì¼ì—ì„œ ìºë¦­í„° ë°ì´í„° ë¡œë“œ
*
* íŒŒì¼: src/main/resources/characters.json
*
* ê³¼ì •:
* 1. ClassPathResourceë¡œ íŒŒì¼ ì½ê¸°
* 2. ObjectMapperë¡œ JSON íŒŒì‹±
* 3. List<Map> í˜•íƒœë¡œ ë³€í™˜
    * 4. charactersCacheì— ì €ì¥
    */
    private List<Map<String, Object>> loadCharactersFromJson() throws IOException {
    ClassPathResource resource = new ClassPathResource(CHARACTERS_JSON_PATH);
    InputStream inputStream = resource.getInputStream();
    ObjectMapper objectMapper = new ObjectMapper();
    return objectMapper.readValue(inputStream, List.class);
    }
    }